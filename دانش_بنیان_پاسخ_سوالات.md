# پاسخ سوالات فنی پروژه آواتار تعاملی هوش مصنوعی

## 1. موتور گفت‌وگو (Conversational AI)

**پاسخ:** سیستم از یک سرویس خارجی برای مدیریت گفت‌وگو استفاده می‌کند که از طریق API فراخوانی می‌شود (`EXTERNAL_CHAT_SERVICE_URL`). این سرویس بر اساس LLM (Large Language Model) کار می‌کند و قابلیت‌های زیر را فراهم می‌کند:

- پردازش زبان طبیعی (NLU) برای درک درخواست‌های کاربر
- مدیریت دیالوگ و حفظ زمینه مکالمه
- تولید پاسخ‌های مناسب بر اساس زمینه مکالمه
- پشتیبانی از چند زبان (فارسی و انگلیسی)
- مدیریت session برای حفظ تاریخچه مکالمه

سرویس به صورت ماژولار و قابل توسعه پیاده‌سازی شده است و امکان اتصال به سرویس‌های مختلف LLM را دارد.

## 2. بومی‌سازی و آموزش مجدد (Fine-tuning)

**پاسخ:** سیستم از مدل آماده استفاده می‌کند که برای محیط فرودگاهی و پاسخگویی به سوالات مسافران بهینه‌سازی شده است. بومی‌سازی از طریق روش‌های زیر انجام می‌شود:

- **پیکربندی Context**: استفاده از Google Sheets برای ذخیره اطلاعات پایه فرودگاهی که به عنوان context به مدل ارسال می‌شود
- **سیستم Cache**: پیاده‌سازی سیستم کش برای جلوگیری از درخواست‌های تکراری و بهبود سرعت پاسخ
- **مدیریت Session**: حفظ تاریخچه مکالمه برای هر session به صورت مجزا
- **پشتیبانی زبان فارسی**: تنظیمات خاص برای زبان فارسی و ارسال پارامتر `language: "fa"` به سرویس

سیستم قابلیت fine-tuning برای دامنه خاص فرودگاه را دارد و می‌تواند با داده‌های آموزشی خاص دامنه بهینه‌سازی شود.

## 3. سامانه تشخیص گفتار فارسی (Speech-to-Text) و تولید گفتار (Text-to-Speech)

### Speech-to-Text (STT):
سیستم از کتابخانه `SpeechRecognition` با استفاده از Google Speech Recognition API استفاده می‌کند. این سرویس قابلیت‌های زیر را دارد:

- تشخیص گفتار فارسی از طریق میکروفون
- تبدیل صوت به متن با دقت بالا
- مدیریت خطاهای تشخیص و retry خودکار
- پشتیبانی از زبان‌های مختلف

### Text-to-Speech (TTS):
سیستم از دو سرویس TTS استفاده می‌کند:

**برای زبان فارسی:**
- **Avashow Service**: سرویس تخصصی فارسی که از طریق API فراخوانی می‌شود
- پشتیبانی از چندین speaker (speaker ID قابل تنظیم)
- تولید فایل صوتی MP3 با کیفیت بالا
- قابلیت تنظیم پارامترهای صوتی (tone, speed)

**برای زبان انگلیسی:**
- **ElevenLabs Service**: سرویس پیشرفته TTS برای زبان انگلیسی
- تولید صوت طبیعی با کیفیت استودیویی
- پشتیبانی از voice cloning و تنظیمات صوت

**فرآیند تولید صوت:**
1. دریافت متن از موتور گفت‌وگو
2. تشخیص زبان (فارسی یا انگلیسی)
3. فراخوانی سرویس TTS مناسب
4. تبدیل صوت به فرمت WAV برای پردازش Lip Sync
5. ذخیره فایل صوتی و تولید Lip Sync data

## 4. کنترل آواتار چهره سه‌بعدی و لب‌خوانی (Lip Sync)

**کنترل آواتار:**
آواتار از طریق پارامترهای زیر کنترل می‌شود:

- **Animation**: انیمیشن‌های مختلف برای حرکات بدن (مثل StandingIdle, Sad, Happy)
- **Facial Expression**: حالت‌های چهره (default, sad, happy, etc.)
- **Lip Sync Data**: داده‌های همگام‌سازی لب با گفتار

**لب‌خوانی (Lip Sync):**
سیستم Lip Sync از ابزار **Rhubarb** استفاده می‌کند که یک ابزار open-source برای تولید داده‌های لب‌خوانی است:

- **ورودی**: فایل صوتی WAV
- **خروجی**: فایل JSON شامل تایمینگ دقیق حرکات لب
- **الگوریتم**: Rhubarb از تحلیل phonetic استفاده می‌کند
- **فرمت خروجی**: JSON با فرمت استاندارد برای استفاده در موتور رندرینگ آواتار

**فرآیند تولید Lip Sync:**
1. تبدیل MP3 به WAV با استفاده از FFmpeg
2. اجرای Rhubarb بر روی فایل WAV
3. تولید فایل JSON حاوی تایمینگ حرکات لب
4. ارسال داده‌های Lip Sync همراه با صوت به کلاینت

## 5. تشخیص چهره یا احساس کاربر

**پاسخ:** در نسخه فعلی سیستم، قابلیت تشخیص چهره یا احساس کاربر مستقیماً پیاده‌سازی نشده است. اما سیستم دارای ساختار ماژولار است که امکان افزودن این قابلیت‌ها را در آینده فراهم می‌کند:

**قابلیت‌های مرتبط موجود:**
- سیستم تشخیص زبان (فارسی/انگلیسی) برای انتخاب TTS مناسب
- مدیریت session برای تشخیص کاربران مختلف
- ذخیره تاریخچه مکالمه برای تحلیل رفتار کاربر

**قابلیت‌های قابل افزودن:**
- تشخیص احساس از طریق تحلیل تن صدا
- تشخیص چهره برای شناسایی کاربران تکراری
- تحلیل حالت صورت کاربر از طریق دوربین

## 6. داده‌های آموزشی الگوریتم تشخیص چهره یا احساس

**پاسخ:** همانطور که در سوال قبلی ذکر شد، در نسخه فعلی سیستم تشخیص چهره یا احساس پیاده‌سازی نشده است. در صورت پیاده‌سازی در آینده، سیستم می‌تواند از داده‌های آموزشی زیر استفاده کند:

- **داده‌های عمومی**: استفاده از دیتاست‌های open-source برای تشخیص احساس
- **داده‌های دامنه‌ای**: جمع‌آوری داده‌های خاص فرودگاه برای بهینه‌سازی
- **Transfer Learning**: استفاده از مدل‌های پیش‌آموخته و fine-tuning برای دامنه خاص

## 7. زمان پاسخ‌گویی سیستم

**پاسخ:** زمان پاسخ‌گویی سیستم از لحظه دریافت صدا تا تولید پاسخ به عوامل زیر بستگی دارد:

**مراحل پردازش:**
1. **Speech-to-Text**: حدود 1-3 ثانیه (بستگی به طول گفتار)
2. **درخواست به موتور گفت‌وگو**: حدود 2-5 ثانیه (بستگی به پیچیدگی سوال)
3. **تولید TTS**: حدود 2-4 ثانیه (بستگی به طول پاسخ)
4. **تولید Lip Sync**: حدود 1-3 ثانیه
5. **پردازش و ارسال**: حدود 0.5-1 ثانیه

**زمان کل تقریبی**: 6.5-16 ثانیه

**بهینه‌سازی‌های انجام شده:**
- استفاده از Cache برای پاسخ‌های تکراری (کاهش زمان به 1-2 ثانیه)
- Retry mechanism با backoff برای مدیریت خطاها
- Connection pooling برای کاهش overhead
- Timeout تنظیم شده به 30 ثانیه برای جلوگیری از انتظار طولانی

**اندازه‌گیری:**
سیستم لاگ کامل از زمان هر مرحله دارد و می‌تواند برای تحلیل performance استفاده شود.

## 8. دقت تشخیص گفتار فارسی

**پاسخ:** برای سنجش دقت تشخیص گفتار فارسی، سیستم از روش‌های زیر استفاده می‌کند:

**روش‌های اندازه‌گیری:**
- **Word Error Rate (WER)**: مقایسه متن تشخیص داده شده با متن مرجع
- **Character Error Rate (CER)**: برای زبان فارسی که از راست به چپ نوشته می‌شود
- **Accuracy Testing**: تست با مجموعه داده استاندارد فارسی

**عوامل مؤثر بر دقت:**
- کیفیت میکروفون و محیط ضبط
- وضوح گفتار کاربر
- نویز محیط
- لهجه و گویش کاربر

**بهبود دقت:**
- استفاده از Google Speech Recognition که از بهترین موتورهای STT برای فارسی است
- پیش‌پردازش صوتی برای کاهش نویز
- Retry mechanism در صورت عدم اطمینان بالا

**نکته:** در محیط production، سیستم عمدتاً متن را از کلاینت دریافت می‌کند (STT در سمت کلاینت انجام می‌شود) که دقت بیشتری دارد.

## 9. نیاز به اینترنت و قابلیت اجرای آفلاین

**پاسخ:** سیستم فعلی **نیاز به اینترنت دارد** برای موارد زیر:

**سرویس‌های آنلاین مورد استفاده:**
- **موتور گفت‌وگو**: استفاده از سرویس خارجی (LLM API)
- **Google Sheets**: برای دریافت اطلاعات پایه فرودگاهی
- **Avashow TTS**: سرویس TTS فارسی
- **ElevenLabs TTS**: سرویس TTS انگلیسی
- **Speech Recognition**: در صورت استفاده از STT سمت سرور

**قابلیت‌های آفلاین:**
- **Rhubarb Lip Sync**: کاملاً آفلاین قابل اجرا است
- **FFmpeg**: برای تبدیل فرمت‌های صوتی (آفلاین)
- **Database**: PostgreSQL می‌تواند آفلاین کار کند
- **Cache**: پاسخ‌های کش شده می‌توانند آفلاین ارائه شوند

**راه‌حل برای اجرای آفلاین:**
- استفاده از مدل LLM محلی (مثل Llama 2 یا GPT4All)
- استفاده از TTS محلی برای فارسی
- ذخیره اطلاعات پایه در دیتابیس به جای Google Sheets
- اجرای کامل سیستم در یک سرور داخلی

## 10. واکنش سیستم در صورت قطع اینترنت

**پاسخ:** سیستم دارای **مدیریت خطا و Fallback** پیشرفته است:

**مکانیزم‌های مدیریت خطا:**

1. **Retry Mechanism:**
   - 3 تلاش متوالی برای درخواست‌های ناموفق
   - Exponential backoff بین تلاش‌ها
   - Timeout تنظیم شده (30 ثانیه)

2. **Error Handling:**
   - در صورت خطا، سیستم پیام خطای مناسب تولید می‌کند
   - استفاده از پیام‌های پیش‌ضبط شده در صورت نیاز
   - حفظ session برای ادامه مکالمه پس از رفع مشکل

3. **Fallback Messages:**
   - سیستم پیام‌های خطای استاندارد دارد
   - در صورت قطع اتصال: `"ERROR_SERVICE_UNAVAILABLE"`
   - نمایش پیام مناسب به کاربر با حالت چهره "sad"

4. **Cache System:**
   - استفاده از cache برای پاسخ‌های قبلی
   - در صورت قطع اینترنت، پاسخ‌های کش شده می‌توانند استفاده شوند

**کد نمونه:**
```python
if attempt == 2:  # آخرین تلاش
    return [{
        "text": "ERROR_SERVICE_UNAVAILABLE",
        "facialExpression": "sad",
        "animation": "Sad",
        "is_error": True,
        "language": language,
    }]
```

## 11. ذخیره‌سازی داده‌ها و امنیت

**ذخیره‌سازی داده‌ها:**

سیستم داده‌های زیر را ذخیره می‌کند:

1. **Messages (پیام‌ها):**
   - متن پیام کاربر
   - متن پاسخ آواتار
   - Session ID
   - تاریخ و زمان
   - نوع فرستنده (CLIENT یا AVATAR)

2. **Responses (پاسخ‌ها):**
   - سوال کاربر
   - پاسخ سیستم
   - Confidence score
   - Session ID
   - User ID (در صورت موجود بودن)

3. **Trips (سفرها):**
   - اطلاعات پرواز
   - اطلاعات مسافر
   - Order ID

4. **Passports (پاسپورت‌ها):**
   - اطلاعات استخراج شده از پاسپورت
   - تصویر پاسپورت (در صورت نیاز)

**امنیت داده:**

1. **Database Security:**
   - استفاده از PostgreSQL با رمزنگاری اتصال (SSL)
   - Connection pooling برای مدیریت اتصالات
   - Parameterized queries برای جلوگیری از SQL Injection

2. **API Security:**
   - استفاده از FastAPI با validation خودکار
   - CORS configuration برای کنترل دسترسی
   - Header validation برای session management

3. **Environment Variables:**
   - ذخیره کلیدهای API در environment variables
   - عدم commit کردن secrets در Git
   - استفاده از `.env` file برای تنظیمات محلی

4. **Data Privacy:**
   - Session-based isolation برای هر کاربر
   - امکان حذف داده‌های session پس از پایان استفاده
   - لاگ‌گیری بدون ذخیره اطلاعات حساس

5. **Backup و Recovery:**
   - امکان backup منظم دیتابیس
   - Migration scripts با Alembic برای مدیریت schema

**بهبودهای پیشنهادی:**
- رمزنگاری داده‌های حساس در دیتابیس
- افزودن Authentication و Authorization
- افزودن Audit logging برای دسترسی‌ها
- پیاده‌سازی Data Retention Policy

## 12. ساختار ماژول‌های نرم‌افزار

**پاسخ:** سیستم از ماژول‌های زیر تشکیل شده است:

### ماژول‌های اصلی:

1. **ASR (Automatic Speech Recognition):**
   - `SpeechService`: تشخیص گفتار با استفاده از Google Speech Recognition
   - قابلیت دریافت صوت از میکروفون
   - تبدیل صوت به متن

2. **NLU (Natural Language Understanding):**
   - `OpenAIService`: ارتباط با سرویس خارجی LLM
   - پردازش درخواست کاربر
   - استخراج intent و entities
   - مدیریت context مکالمه

3. **Dialogue Manager:**
   - مدیریت session و تاریخچه مکالمه
   - حفظ context بین تبادلات
   - مدیریت state مکالمه
   - در `OpenAIService` و route handlers پیاده‌سازی شده

4. **Knowledge Base:**
   - `GoogleSheetsService`: دریافت اطلاعات پایه از Google Sheets
   - ذخیره و مدیریت اطلاعات فرودگاهی
   - ارائه context به موتور گفت‌وگو

5. **TTS (Text-to-Speech):**
   - `AvashowService`: TTS فارسی
   - `ElevenLabsService`: TTS انگلیسی
   - تشخیص خودکار زبان
   - تولید فایل صوتی MP3

6. **Lip Sync Generator:**
   - `LipSyncService`: تولید داده‌های لب‌خوانی
   - استفاده از Rhubarb
   - تبدیل MP3 به WAV
   - تولید JSON برای Lip Sync

7. **File Service:**
   - `FileService`: مدیریت فایل‌های صوتی و JSON
   - تبدیل فایل‌ها به Base64
   - خواندن و نوشتن فایل‌ها

8. **Database Service:**
   - `database.py`: مدیریت اتصال به PostgreSQL
   - Connection pooling
   - Session management

9. **Models:**
   - `Message`, `Response`, `Trip`, `Passport`: مدل‌های دیتابیس
   - استفاده از SQLAlchemy ORM

10. **API Routes:**
    - `assistant_routes`: endpoint اصلی گفت‌وگو
    - `message_routes`: مدیریت پیام‌ها
    - `trip_routes`: مدیریت سفرها
    - `passport_routes`: پردازش پاسپورت
    - `extract_info_routes`: استخراج اطلاعات

### معماری:
```
Client Request
    ↓
FastAPI Routes
    ↓
Services Layer (OpenAI, TTS, LipSync, etc.)
    ↓
Database Layer (PostgreSQL)
    ↓
External APIs (LLM, TTS Services)
```

## 13. زبان برنامه‌نویسی و فریم‌ورک

**پاسخ:**

**زبان برنامه‌نویسی:**
- **Python 3.7+**: زبان اصلی توسعه

**فریم‌ورک‌ها و کتابخانه‌های اصلی:**

1. **Web Framework:**
   - **FastAPI 0.109.2**: فریم‌ورک اصلی برای REST API
   - **Uvicorn 0.27.1**: ASGI server برای اجرای FastAPI

2. **Database:**
   - **SQLAlchemy 2.0.36**: ORM برای کار با دیتابیس
   - **psycopg[binary] 3.2.3**: درایور PostgreSQL

3. **AI/ML Services:**
   - **openai >= 1.68.2**: SDK برای OpenAI (در صورت نیاز مستقیم)
   - **SpeechRecognition 3.10.1**: کتابخانه تشخیص گفتار

4. **HTTP & Networking:**
   - **requests >= 2.31.0**: برای درخواست‌های HTTP
   - **urllib3**: برای retry و connection pooling

5. **Data Validation:**
   - **pydantic >= 2.7.4, <3.0.0**: برای validation داده‌ها

6. **Image Processing:**
   - **pytesseract 0.3.10**: OCR برای پردازش پاسپورت
   - **Pillow 10.4.0**: پردازش تصویر

7. **Utilities:**
   - **python-dotenv 1.0.1**: مدیریت environment variables
   - **python-multipart 0.0.20**: برای upload فایل‌ها
   - **tokenizers**: برای پردازش متن (در صورت نیاز)

8. **External Tools:**
   - **FFmpeg**: برای تبدیل فرمت‌های صوتی (command-line tool)
   - **Rhubarb**: برای تولید Lip Sync (executable binary)

**ساختار پروژه:**
```
api/
├── app.py                 # FastAPI application
├── database/              # Database configuration
├── models/                # SQLAlchemy models
├── routes/                # API routes
├── schemas/               # Pydantic schemas
└── services/              # Business logic services
```

**ویژگی‌های معماری:**
- **RESTful API**: طراحی API بر اساس استاندارد REST
- **Dependency Injection**: استفاده از FastAPI Depends
- **Async Support**: پشتیبانی از async/await
- **Auto Documentation**: Swagger UI خودکار
- **Type Hints**: استفاده کامل از type hints

## 14. رابط مدیریتی برای تنظیم و پایش آواتار

**پاسخ:** در نسخه فعلی، یک **رابط مدیریتی کامل** به صورت مستقل پیاده‌سازی نشده است، اما سیستم دارای **قابلیت‌های پایش و مدیریت** زیر است:

**قابلیت‌های موجود:**

1. **API Documentation (Swagger UI):**
   - دسترسی خودکار به `/docs` برای مستندات API
   - امکان تست endpoint‌ها مستقیماً از مرورگر
   - نمایش schema و validation rules

2. **Health Check Endpoint:**
   - `GET /`: بررسی وضعیت سیستم
   - بررسی اتصال به دیتابیس
   - بررسی دسترسی به سرویس‌های خارجی (OpenAI, Google Sheets)
   - نمایش وضعیت هر سرویس

3. **Logging System:**
   - لاگ کامل از تمام عملیات
   - لاگ خطاها و exception‌ها
   - لاگ زمان پاسخ‌دهی
   - قابلیت بررسی performance

4. **Database Management:**
   - استفاده از **Alembic** برای migration
   - امکان backup و restore
   - Scripts برای بررسی و fix دیتابیس

5. **Monitoring Endpoints:**
   - `GET /api/v1/responses`: مشاهده پاسخ‌های ذخیره شده
   - `GET /api/v1/messages`: مشاهده پیام‌های کاربران
   - `GET /api/v1/trips`: مدیریت سفرها

**راه‌حل‌های قابل پیاده‌سازی:**

1. **Admin Dashboard:**
   - رابط کاربری برای مشاهده آمار
   - مدیریت session‌ها
   - تنظیمات سیستم
   - مشاهده لاگ‌ها

2. **Configuration Management:**
   - تغییر تنظیمات بدون restart
   - مدیریت API keys
   - تنظیم timeout و retry policies

3. **Analytics Dashboard:**
   - آمار استفاده
   - تحلیل عملکرد سیستم
   - نمودار زمان پاسخ‌دهی
   - آمار خطاها

4. **Real-time Monitoring:**
   - نمایش وضعیت real-time سیستم
   - Alerting در صورت خطا
   - نمایش session‌های فعال

**نکته:** سیستم دارای ساختار ماژولار است که امکان افزودن Admin Panel را به راحتی فراهم می‌کند.

---

## خلاصه فنی

**فناوری‌های کلیدی:**
- Python + FastAPI برای Backend
- PostgreSQL برای ذخیره‌سازی
- LLM API برای گفت‌وگو
- Avashow/ElevenLabs برای TTS
- Rhubarb برای Lip Sync
- Google Speech Recognition برای STT

**نقاط قوت:**
- معماری ماژولار و قابل توسعه
- مدیریت خطا و retry mechanism
- Cache system برای بهبود performance
- پشتیبانی چند زبانه
- Session management پیشرفته

**قابلیت‌های قابل توسعه:**
- تشخیص احساس و چهره
- Admin Dashboard
- اجرای آفلاین
- Fine-tuning مدل برای دامنه خاص

